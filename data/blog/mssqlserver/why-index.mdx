---
title: 'Why Index?'
date: 2025-03-26T15:32:14Z
lastmod: '2021-02-01'
tags: ['mssqlserver', 'index', 'database']
draft: false
summary: 'An overview of the new features released in v1 - code block copy, multiple authors, frontmatter layout and more'
layout: PostSimple
bibliography: references-data.bib
---

## 聚集索引

聚集索引通常在创建主键时自动生成，也可以由用户手动指定。它基于 B+ 树结构构建，包含根页、中间页和叶页（数据页），共同构成索引路径。查询时，SQL Server 会根据元数据定位根页，通过索引键逐层向下查找，最终定位到目标数据页以返回结果。

在未深入了解之前，我对这些描述也觉得很抽象。因为我只知道库、表、列、行；只知道查询慢了就加索引，但为什么加、索引具体解决了什么问题，并不了解。要真正理解索引是如何加快查询速度的，我们还需要从更底层的角度看看。

## 数据库引擎究竟是如何定位并读取数据的？

在数据库引擎中，数据页是最小的物理存储单位，大小为 8KB，每个数据页用于存储若干行数据。数据库引擎为每个数据页分配唯一的页号用于逻辑管理。当需要读取某个数据页时，SQL Server 会通过页号 × 8KB 计算出其在 .mdf 文件中的偏移量，从而定位该数据页在文件中的具体位置。

快速理解偏移量：可以把 .mdf 文件看作一个连续的字节流，从文件起始位置（偏移 0）开始，每间隔 8KB 就是一个新的数据页。偏移量就是数据页在这个字节流中的“起始字节位置”。

实际读取过程中，数据库引擎并不直接操作磁盘，而是将计算出的偏移量和目标文件路径交由操作系统处理。操作系统通过文件系统（如 NTFS）中的元数据结构，查找该偏移量所对应的物理磁盘位置。然后从对应的磁盘区域读取数据，返回给数据库引擎。

整个过程中，SQL Server 负责“逻辑寻址”（页号 → 偏移量），而操作系统负责“物理寻址”（偏移量 → 磁盘位置），两者协同完成从磁盘到内存的数据加载过程。

## 堆表

堆表是一种没有聚集索引的表。不多赘述。

新增时，SQL Server 会查询 PFS（Page Free Space）页，找到第一个有空间的数据页，将新行数据插入其中。没有就向GAM（Global Allocation Map）页申请新的数据页。

查询时，SQL Server 会根据IAM（Index Allocation Map）中记录的页分布信息，遍历表中所有的数据页，读取其中的行数据，直到满足查询条件或扫描完所有页。

删除，更新不多赘述。但更新时，更新后的数据导致数据页空间超过8KB时，会导致严重的性能问题，感兴趣的可以自行查阅。
